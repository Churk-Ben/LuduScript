# LuduScript 语法规范

## 概念

- **变量**: 用于存储数据的容器
- **数据类型**: 变量可以存储的数据的类型, 如数值, 字符串, 布尔值
- **表达式**: 由变量, 操作符和函数调用组成的代码片段, 用于计算值. 表达式不含{}
- **语句**: 独立的代码单位, 用于执行特定的操作
- **保留函数**: 解释器内置的函数, 用于执行特定的操作, 如类型转换, 随机数生成等

## 基本数据类型

- **数值 (num)**: 支持长整型数值和双精度浮点数
- **字符串 (str)**: 双引号包围的字符串，支持转义字符 `\n`, `\t`, `\"`, `\\`
- **布尔值 (bool)**: `true` 和 `false`

## 变量声明

```lud
num(变量名) { 初始值 }    // 数值变量
str(变量名) { 初始值 }    // 字符串变量  
bool(变量名) { 初始值 }   // 布尔变量
```

如果不提供初始值，默认值为：num=0, str="", bool=false

### 初始化块语法

在{}内可以书写复杂的语句块，支持以下语法：

**基本语句块**：

```lud
num(变量名) {
    // 语句块
    num(i) { 10 }
    num(j) { 20 }
    num(k) { i + j }
    // 最后一个定义的变量k会作为变量的值
}
```

**支持条件语句**：

```lud
num(hp) {
    num(base_hp) { 100 }
    if(level > 10) {
        num(bonus) { 50 }
    } else {
        num(bonus) { 20 }
    }
    num(total) { base_hp + bonus }
    total  // 返回计算结果
}
```

**支持循环语句**：

```lud
num(total_damage) {
    num(sum) { 0 }
    for(i, 1, 5) {
        num(sum) { sum + i * 10 }
    }
    sum  // 返回累计结果
}
```

**重要说明**：

- 初始化块内的最后一个表达式或变量声明的值将作为该字段的最终值
- 如果没有显式返回值，将使用该类型的默认值（num=0, str="", bool=false）
- 初始化块内可以使用外部作用域的变量

## 对象创建

```lud
obj("类名", ID表达式) {
    // 对象属性定义
    num(属性名) { 值 }
    str(属性名) { 值 }
    bool(属性名) { 值 }
}
```

### 对象字段相互引用

对象内部的字段可以相互引用，支持复杂的计算逻辑：

```lud
obj("Equipment", 1001) {
    num(base_attack) { 10 }
    num(enhance_level) { 3 }
    
    // 字段可以引用同一对象内的其他字段
    num(bonus_attack) {
        num(bonus_per_level) { 2 }
        num(total_bonus) { bonus_per_level * enhance_level }
        total_bonus
    }
    
    // 计算最终攻击力
    num(final_attack) { base_attack + bonus_attack }
    
    // 字符串字段也可以引用数值字段
    str(description) { "攻击力: " + final_attack }
}
```

**字段引用规则**：

- 字段必须在引用前已经声明
- 支持在初始化块内引用同一对象的其他字段
- 字段引用遵循声明顺序，不能前向引用
- 可以在字符串拼接中使用数值字段

**基本属性**：

- 对象会自动添加 `class` 和 `id` 字段
- 所有创建的对象会输出到JSON数组中

## 控制流语句

### 条件语句

```lud
if(条件表达式) {
    // 语句块
}
elif(条件表达式) {
    // 语句块  
}
else {
    // 语句块
}
```

### 循环语句

```lud
for(迭代变量, 总数) {           // 从1到总数
    // 语句块
}

for(迭代变量, 起始值, 结束值) { // 从起始值到结束值
    // 语句块
}

for(迭代变量, 起始值, 结束值, 步长) {
    // 语句块
}
```

> luduScript 将不会支持无限循环 (即不会加入 while(){} 语句)

循环跳出语句

```lud
break    // 跳出当前循环
continue // 跳过当前循环的剩余语句, 进入下一次循环
```

### 表达式和操作符

### 算术操作符

- `+` (加法)
- `-` (减法)
- `*` (乘法)
- `/` (除法)
- `%` (取模)

### 比较操作符

- `==` (等于)
- `!=` (不等于)
- `<` (小于)
- `>` (大于)
- `<=` (小于等于)
- `>=` (大于等于)

### 逻辑操作符

- `&&` (逻辑与)
- `||` (逻辑或)
- `!` (逻辑非)

### 一元操作符

- `-` (负号)
- `!` (逻辑非)

## 注释

- 行注释：`// 注释内容`

## 语法特点

1. **面向对象生成**：主要用于生成JSON格式的对象数据
2. **类型安全**：支持三种基本数据类型的声明和转换
3. **作用域管理**：支持块级作用域和变量栈
4. **表达式优先级**：按标准数学运算优先级处理
5. **灵活的for循环**：支持1-3个参数的不同循环模式
6. **复杂初始化块**：支持在变量初始化块内使用条件语句、循环语句等复杂逻辑
7. **对象字段引用**：对象内部字段可以相互引用，支持复杂的计算和依赖关系
8. **智能作用域处理**：初始化块内的变量作用域与对象字段作用域分离，避免命名冲突

## 输出格式

解释器执行后会生成JSON数组，包含所有创建的对象，每个对象都有：

- `class`: 对象类名
- `id`: 对象ID
- 其他用户定义的属性

这个语言特别适合用于游戏开发中的卡牌、道具、角色等游戏对象的批量生成和配置。
